/*
 * FOC.c
 *
 *  Created on: Oct 1, 2019
 *      Author: LoganRosenmayer
 */
#include "FOC.h"

static float pc_coff = 0.8164965;
static float data2angle = 0.3515625;
static float sin_lut_table[360] = {0,0.017452406,0.034899497,0.052335956,0.069756474,0.087155743,0.104528463,0.121869343,0.139173101,0.156434465,0.173648178,0.190808995,0.207911691,0.224951054,0.241921896,0.258819045,0.275637356,0.292371705,0.309016994,0.325568154,0.342020143,0.35836795,0.374606593,0.390731128,0.406736643,0.422618262,0.438371147,0.4539905,0.469471563,0.48480962,0.5,0.515038075,0.529919264,0.544639035,0.559192903,0.573576436,0.587785252,0.601815023,0.615661475,0.629320391,0.64278761,0.656059029,0.669130606,0.68199836,0.69465837,0.707106781,0.7193398,0.731353702,0.743144825,0.75470958,0.766044443,0.777145961,0.788010754,0.79863551,0.809016994,0.819152044,0.829037573,0.838670568,0.848048096,0.857167301,0.866025404,0.874619707,0.882947593,0.891006524,8.99E-01,0.906307787,0.913545458,0.920504853,0.927183855,0.933580426,0.939692621,0.945518576,0.951056516,0.956304756,0.961261696,0.965925826,0.970295726,0.974370065,0.978147601,0.981627183,0.984807753,0.987688341,0.990268069,0.992546152,0.994521895,0.996194698,0.99756405,0.998629535,0.999390827,0.999847695,1,0.999847695,0.999390827,0.998629535,0.99756405,0.996194698,0.994521895,0.992546152,0.990268069,0.987688341,0.984807753,0.981627183,0.978147601,0.974370065,0.970295726,0.965925826,0.961261696,0.956304756,0.951056516,0.945518576,0.939692621,0.933580426,0.927183855,0.920504853,0.913545458,0.906307787,0.898794046,0.891006524,0.882947593,0.874619707,0.866025404,0.857167301,0.848048096,0.838670568,0.829037573,0.819152044,0.809016994,0.79863551,0.788010754,0.777145961,0.766044443,0.75470958,0.743144825,0.731353702,0.7193398,0.707106781,0.69465837,0.68199836,0.669130606,0.656059029,0.64278761,0.629320391,0.615661475,0.601815023,0.587785252,0.573576436,0.559192903,0.544639035,0.529919264,0.515038075,0.5,0.48480962,0.469471563,0.4539905,0.438371147,0.422618262,0.406736643,0.390731128,0.374606593,0.35836795,0.342020143,0.325568154,0.309016994,0.292371705,0.275637356,0.258819045,0.241921896,0.224951054,0.207911691,0.190808995,0.173648178,0.156434465,0.139173101,0.121869343,0.104528463,0.087155743,0.069756474,0.052335956,0.034899497,0.017452406,1.22E-16,-0.017452406,-0.034899497,-0.052335956,-0.069756474,-0.087155743,-0.104528463,-0.121869343,-0.139173101,-0.156434465,-0.173648178,-0.190808995,-0.207911691,-0.224951054,-0.241921896,-0.258819045,-0.275637356,-0.292371705,-0.309016994,-0.325568154,-0.342020143,-0.35836795,-0.374606593,-0.390731128,-0.406736643,-0.422618262,-0.438371147,-0.4539905,-0.469471563,-0.48480962,-0.5,-0.515038075,-0.529919264,-0.544639035,-0.559192903,-0.573576436,-0.587785252,-0.601815023,-0.615661475,-0.629320391,-0.64278761,-0.656059029,-0.669130606,-0.68199836,-0.69465837,-0.707106781,-0.7193398,-0.731353702,-0.743144825,-0.75470958,-0.766044443,-0.777145961,-0.788010754,-0.79863551,-0.809016994,-0.819152044,-0.829037573,-0.838670568,-0.848048096,-0.857167301,-0.866025404,-0.874619707,-0.882947593,-0.891006524,-0.898794046,-0.906307787,-0.913545458,-0.920504853,-0.927183855,-0.933580426,-0.939692621,-0.945518576,-0.951056516,-0.956304756,-0.961261696,-0.965925826,-0.970295726,-0.974370065,-0.978147601,-0.981627183,-0.984807753,-0.987688341,-0.990268069,-0.992546152,-0.994521895,-0.996194698,-0.99756405,-0.998629535,-0.999390827,-0.999847695,-1,-0.999847695,-0.999390827,-0.998629535,-0.99756405,-0.996194698,-0.994521895,-0.992546152,-0.990268069,-0.987688341,-0.984807753,-0.981627183,-0.978147601,-0.974370065,-0.970295726,-0.965925826,-0.961261696,-0.956304756,-0.951056516,-0.945518576,-0.939692621,-0.933580426,-0.927183855,-0.920504853,-0.913545458,-0.906307787,-0.898794046,-0.891006524,-0.882947593,-0.874619707,-0.866025404,-0.857167301,-0.848048096,-0.838670568,-0.829037573,-0.819152044,-0.809016994,-0.79863551,-0.788010754,-0.777145961,-0.766044443,-0.75470958,-0.743144825,-0.731353702,-0.7193398,-0.707106781,-0.69465837,-0.68199836,-0.669130606,-0.656059029,-0.64278761,-0.629320391,-0.615661475,-0.601815023,-0.587785252,-0.573576436,-0.559192903,-0.544639035,-0.529919264,-0.515038075,-0.5,-0.48480962,-0.469471563,-0.4539905,-0.438371147,-0.422618262,-0.406736643,-0.390731128,-0.374606593,-0.35836795,-0.342020143,-0.325568154,-0.309016994,-0.292371705,-0.275637356,-0.258819045,-0.241921896,-0.224951054,-0.207911691,-0.190808995,-0.173648178,-0.156434465,-0.139173101,-0.121869343,-0.104528463,-0.087155743,-0.069756474,-0.052335956,-0.034899497,-0.017452406};

int rawdata_to_angle(int rawdata)
{
return((int)(data2angle*rawdata));
}

void parkclark(int Ia,int Ib,int Ic,int theta,float *Iq,float *Id )
{
//	float part1,part2,part3;
//	if(Ia>10000||Ia<-10000){
//		part1=0;
//	}
//	part1=-sin_lut(theta)*Ia;
//	part2=-sin_lut(theta+240)*Ib;
//	part3=-sin_lut(theta+120)*Ic;
	*Iq = (pc_coff*(-sin_lut(theta)*Ia - sin_lut(theta+240)*Ib - sin_lut(theta+120)*Ic))*0.001;
	*Id = (pc_coff*(cos_lut(theta)*Ia + cos_lut(theta+240)*Ib + cos_lut(theta+120)*Ic))*0.001;
}

void inv_parkclark(int *Va,int *Vb,int *Vc,int theta,int Vq,int Vd )
{
	*Va = (int)(pc_coff*(cos_lut(theta)*Vd - sin_lut(theta)*Vq));
	*Vb = (int)(pc_coff*(cos_lut(theta+240)*Vd - sin_lut(theta+240)*Vq));
	*Vc = (int)(pc_coff*(cos_lut(theta+120)*Vd - sin_lut(theta+120)*Vq));
}
float sin_lut(int angle){
	return(sin_lut_table[angle%360]);
}
float cos_lut(int angle){
	return(sin_lut_table[(angle+90)%360]);
}
